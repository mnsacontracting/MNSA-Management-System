import streamlit as st
import pandas as pd

st.set_page_config(page_title="MNSA - ุงูุญุตุฑ ุงูููุฏุณู ุงูุดุงูู", layout="wide")
st.title("๐๏ธ ุงููุญุฑู ุงูุงุญุชุฑุงูู ูุญุตุฑ ุงูุฎุงูุงุช - MNSA")

def smart_find_columns(df):
    targets = {
        'desc': ['ุจูุงู ุงูุฃุนูุงู', 'ุจูุงู ุงูุงุนูุงู', 'ุงูุจูุฏ', 'ุงููุตู', 'item'],
        'qty': ['ุงููููุฉ', 'ุงููููุงุช', 'qty', 'quantity'],
        'price': ['ุงููุฆุฉ', 'ุงูุณุนุฑ', 'price']
    }
    found = {'desc': None, 'qty': None, 'price': None}
    for col in df.columns:
        c = str(col).strip().lower()
        for k, v in targets.items():
            if any(term in c for term in v): found[k] = col
    return found

def detailed_takeoff(df, cols):
    # ูุตูููุฉ ุงูุฎุงูุงุช ุงููุทูุฑุฉ
    m = {
        "ุฃุณููุช ุจูุฑุชูุงูุฏู (ุทู)": 0, "ุฑูู ุญุฑุด (ู3)": 0, "ุณู / ุฒูุท (ู3)": 0, "ุญุฏูุฏ ุชุณููุญ (ุทู)": 0,
        "ุทูุจ ุฃุณููุชู/ุทููู (ุฃูู)": 0, "ููุงุฆู ุนุฒู ุจูุชูููู (ู2)": 0, "ุณูุฑุงููู/ุจูุฑุณููู (ู2)": 0,
        "ูุคููุฉ ูุตู ุณูุฑุงููู (ุดูุงุฑุฉ)": 0, "ูุนุฌูู ุญูุงุฆุท (ุดูุงุฑุฉ)": 0, "ุฏูุงู ุจูุงุณุชูู (ุจุณุชูุฉ)": 0,
        "ููุงุณูุฑ ุญุฑูู (ู.ุท)": 0, "ููุงุณูุฑ ุตุฑู UPVC (ู.ุท)": 0, "ูุทุน ุฎุงุตุฉ / ูุญุงุจุณ (ุนุฏุฏ)": 0,
        "ุฎุดุจ ุทูุจุงุฑ (ุชูุฏูุฑู ู3)": 0
    }
    total_val = 0

    for _, row in df.iterrows():
        try:
            item = str(row[cols['desc']]).lower()
            qty = pd.to_numeric(row[cols['qty']], errors='coerce') or 0
            price = pd.to_numeric(row[cols['price']], errors='coerce') if cols['price'] else 0
            total_val += (qty * price)

            # 1. ุชุญููู ุงูุฎุฑุณุงูุงุช (ุนุงุฏูุฉ ููุณูุญุฉ)
            if "ุฎุฑุณุงูุฉ ูุณูุญุฉ" in item or "ููุฏ" in item or "ุฃุนูุฏุฉ" in item:
                m["ุฃุณููุช ุจูุฑุชูุงูุฏู (ุทู)"] += qty * 0.350
                m["ุฑูู ุญุฑุด (ู3)"] += qty * 0.40
                m["ุณู / ุฒูุท (ู3)"] += qty * 0.80
                m["ุญุฏูุฏ ุชุณููุญ (ุทู)"] += qty * 0.095 # ูุชูุณุท 95 ูุฌู/ู3
            elif "ุฎุฑุณุงูุฉ ุนุงุฏูุฉ" in item or "ูุฑุดุฉ" in item:
                m["ุฃุณููุช ุจูุฑุชูุงูุฏู (ุทู)"] += qty * 0.250
                m["ุฑูู ุญุฑุด (ู3)"] += qty * 0.40
                m["ุณู / ุฒูุท (ู3)"] += qty * 0.80

            # 2. ุชุญููู ุงูุดุจูุงุช (ุญุฑูู ูุตุฑู)
            if "ุญุฑูู" in item or "fhc" in item:
                m["ููุงุณูุฑ ุญุฑูู (ู.ุท)"] += qty
                if "ุตูุฏูู" in item or "ูุญุจุณ" in item: m["ูุทุน ุฎุงุตุฉ / ูุญุงุจุณ (ุนุฏุฏ)"] += qty
            elif "ุตุฑู" in item or "upvc" in item or "pvc" in item:
                m["ููุงุณูุฑ ุตุฑู UPVC (ู.ุท)"] += qty

            # 3. ุชุญููู ุงูุชุดุทูุจุงุช (ุฏูุงูุงุชุ ุณูุฑุงูููุ ูุญุงุฑุฉ)
            if any(x in item for x in ["ุณูุฑุงููู", "ุจูุฑุณููู", "ุจูุงุท"]):
                m["ุณูุฑุงููู/ุจูุฑุณููู (ู2)"] += qty
                m["ูุคููุฉ ูุตู ุณูุฑุงููู (ุดูุงุฑุฉ)"] += qty * 0.20
            if "ุฏูุงูุงุช" in item or "ุจูุงุณุชูู" in item:
                m["ูุนุฌูู ุญูุงุฆุท (ุดูุงุฑุฉ)"] += qty * 0.05
                m["ุฏูุงู ุจูุงุณุชูู (ุจุณุชูุฉ)"] += qty / 25
            if "ูุญุงุฑุฉ" in item or "ุจูุงุถ" in item:
                m["ุฃุณููุช ุจูุฑุชูุงูุฏู (ุทู)"] += qty * 0.015
                m["ุฑูู ุญุฑุด (ู3)"] += qty * 0.035

        except: continue
    return m, total_val

uploaded_file = st.file_uploader("ุงุฑูุน ููุงูุณุฉ ุงููุดุฑูุน (Excel)", type=['xlsx', 'xls'])

if uploaded_file:
    df = pd.read_excel(uploaded_file)
    cols = smart_find_columns(df)
    
    if cols['desc'] and cols['qty']:
        if st.button("๐ ุจุฏุก ุงูุชุญููู ุงูููุฏุณู ูุงูุญุตุฑ"):
            results, total_v = detailed_takeoff(df, cols)
            
            # ุนุฑุถ ุงูุฅุฌูุงูู ุงููุงูู
            st.metric("๐ฐ ุงููููุฉ ุงูุฅุฌูุงููุฉ ูููุดุฑูุน", f"{total_v:,.2f} ุฌ.ู")
            st.markdown("---")

            # ุนุฑุถ ุงููุชุงุฆุฌ ูู ุชุจููุจุงุช ููุธูุฉ
            tab1, tab2, tab3 = st.tabs(["๐๏ธ ุฃุนูุงู ุงูุฅูุดุงุกุงุช", "๐จ ุฃุนูุงู ุงูุชุดุทูุจุงุช", "๐ฟ ุงูุดุจูุงุช ูุงูููุงุณูุฑ"])
            
            with tab1:
                c1, c2 = st.columns(2)
                c1.metric("ุงูุฃุณููุช ุงูููู (ุทู)", f"{results['ุฃุณููุช ุจูุฑุชูุงูุฏู (ุทู)']:,.2f}")
                c1.metric("ุญุฏูุฏ ุงูุชุณููุญ (ุทู)", f"{results['ุญุฏูุฏ ุชุณููุญ (ุทู)']:,.2f}")
                c2.metric("ุงูุฑูู (ู3)", f"{results['ุฑูู ุญุฑุด (ู3)']:,.2f}")
                c2.metric("ุงูุณู / ุงูุฒูุท (ู3)", f"{results['ุณู / ุฒูุท (ู3)']:,.2f}")

            with tab2:
                c1, c2 = st.columns(2)
                c1.metric("ุณูุฑุงููู (ู2)", f"{results['ุณูุฑุงููู/ุจูุฑุณููู (ู2)']:,.2f}")
                c1.metric("ุฏูุงูุงุช (ุจุณุชูุฉ)", f"{results['ุฏูุงู ุจูุงุณุชูู (ุจุณุชูุฉ)']:,.2f}")
                c2.metric("ูุนุฌูู ุญูุงุฆุท (ุดูุงุฑุฉ)", f"{results['ูุนุฌูู ุญูุงุฆุท (ุดูุงุฑุฉ)']:,.2f}")
                c2.metric("ูุคููุฉ ูุตู (ุดูุงุฑุฉ)", f"{results['ูุคููุฉ ูุตู ุณูุฑุงููู (ุดูุงุฑุฉ)']:,.2f}")

            with tab3:
                c1, c2 = st.columns(2)
                c1.metric("ููุงุณูุฑ ุญุฑูู (ู.ุท)", f"{results['ููุงุณูุฑ ุญุฑูู (ู.ุท)']:,.2f}")
                c2.metric("ููุงุณูุฑ ุตุฑู (ู.ุท)", f"{results['ููุงุณูุฑ ุตุฑู UPVC (ู.ุท)']:,.2f}")
                st.metric("ูุทุน ุฎุงุตุฉ ููุญุงุจุณ (ุนุฏุฏ)", f"{results['ูุทุน ุฎุงุตุฉ / ูุญุงุจุณ (ุนุฏุฏ)']:,.2f}")

    else:
        st.error("ูู ุฃุฌุฏ ุฃุนูุฏุฉ (ุจูุงู ุงูุฃุนูุงู) ู (ุงููููุฉ). ูุฑุฌู ุงูุชุญูู ูู ุชุณููุฉ ุงูุฃุนูุฏุฉ ูู ุงูููู.")
