import streamlit as st
import pandas as pd

# 1. ุฅุนุฏุงุฏุงุช ุงูุตูุญุฉ
st.set_page_config(page_title="MNSA ERP - ุงูุญุตุฑ ุงูุงุญุชุฑุงูู", layout="wide")
st.title("๐๏ธ ุขูุฉ ุงูููุชุจ ุงูููู ูุดุฑูุฉ MNSA")
st.info("ูุง ูุตุทููุ ุฅุฐุง ูู ูุชุนุฑู ุงููุธุงู ุขููุงูุ ุงุฎุชุฑ ุฃุณูุงุก ุงูุฃุนูุฏุฉ ูู ุงูููุงุฆู ุงูุชู ุณุชุธูุฑ ูู.")

# --- ูุงุฌูุฉ ุฑูุน ุงูููู ---
uploaded_file = st.file_uploader("ุงุฑูุน ููู ุงูููุงูุณุฉ (Excel)", type=['xlsx', 'xls'])

if uploaded_file:
    # ูุฑุงุกุฉ ุงูููู
    df = pd.read_excel(uploaded_file)
    
    st.markdown("---")
    st.subheader("๐ ุฅุนุฏุงุฏุงุช ุงูุชุนุฑู ุนูู ุงูุจูุงูุงุช")
    
    # ุนุฑุถ ูุงุฆูุฉ ุจูู ุฃุนูุฏุฉ ุงูููู ููุฎุชุงุฑ ูุตุทูู ูููุง
    all_columns = df.columns.tolist()
    
    col1, col2, col3 = st.columns(3)
    with col1:
        desc_col = st.selectbox("ุงุฎุชุฑ ุนููุฏ (ุจูุงู ุงูุฃุนูุงู):", all_columns)
    with col2:
        qty_col = st.selectbox("ุงุฎุชุฑ ุนููุฏ (ุงููููุฉ):", all_columns)
    with col3:
        price_col = st.selectbox("ุงุฎุชุฑ ุนููุฏ (ุงููุฆุฉ/ุงูุณุนุฑ) - ุงุฎุชูุงุฑู:", ["ูุง ููุฌุฏ"] + all_columns)

    if st.button("๐ ุชูููุฐ ุงูุญุตุฑ ุงูุดุงูู"):
        # ุชุฌููุฒ ุงููุชุงุฆุฌ
        results = {
            "ุฃุณููุช (ุทู)": 0, "ุญุฏูุฏ (ุทู)": 0, "ุฑูู (ู3)": 0, "ุณู/ุฒูุท (ู3)": 0,
            "ุทูุจ (ุฃูู)": 0, "ุณูุฑุงููู (ู2)": 0, "ุฏูุงูุงุช (ุจุณุชูุฉ)": 0,
            "ุฃุจูุงุจ (ุนุฏุฏ)": 0, "ุดุจุงุจูู (ุนุฏุฏ)": 0, "ููุงุณูุฑ ุดุจูุงุช (ู.ุท)": 0
        }
        total_val = 0
        
        # ุชุญููู ุงููููุงุช ูุฃุฑูุงู
        df[qty_col] = pd.to_numeric(df[qty_col], errors='coerce')
        df_clean = df.dropna(subset=[qty_col])

        for _, row in df_clean.iterrows():
            item = str(row[desc_col]).lower()
            qty = float(row[qty_col])
            
            # ุญุณุงุจ ุงููููุฉ ุงููุงููุฉ ูู ูุฌุฏ ุนููุฏ ุณุนุฑ
            if price_col != "ูุง ููุฌุฏ":
                price = pd.to_numeric(row[price_col], errors='coerce') or 0
                total_val += (qty * price)

            # --- ููุทู ุงูุญุตุฑ ุงูููุฏุณู ---
            if any(x in item for x in ["ูุณูุญุฉ", "ููุฏ", "ุฃุนูุฏุฉ", "ุณูู", "ููุฑุฉ"]):
                results["ุฃุณููุช (ุทู)"] += qty * 0.35
                results["ุญุฏูุฏ (ุทู)"] += qty * 0.095
                results["ุฑูู (ู3)"] += qty * 0.4
                results["ุณู/ุฒูุท (ู3)"] += qty * 0.8
            elif "ุนุงุฏูุฉ" in item or "ูุฑุดุฉ" in item:
                results["ุฃุณููุช (ุทู)"] += qty * 0.25
                results["ุฑูู (ู3)"] += qty * 0.4
                results["ุณู/ุฒูุท (ู3)"] += qty * 0.8
            
            if "ุณูุฑุงููู" in item or "ุจูุฑุณููู" in item: results["ุณูุฑุงููู (ู2)"] += qty
            if "ุฏูุงู" in item or "ุจูุงุณุชูู" in item: results["ุฏูุงูุงุช (ุจุณุชูุฉ)"] += qty / 25
            if "ุจุงุจ" in item: results["ุฃุจูุงุจ (ุนุฏุฏ)"] += qty
            if "ุดุจุงู" in item: results["ุดุจุงุจูู (ุนุฏุฏ)"] += qty
            if any(x in item for x in ["ููุงุณูุฑ", "ุญุฑูู", "ุตุฑู", "ุดุจูุฉ"]): results["ููุงุณูุฑ ุดุจูุงุช (ู.ุท)"] += qty

        # --- ุนุฑุถ ุงููุชุงุฆุฌ ---
        if total_val > 0:
            st.metric("๐ฐ ุฅุฌูุงูู ูููุฉ ุงูููุงูุณุฉ", f"{total_val:,.2f} ุฌููู")
            
        st.markdown("---")
        t1, t2, t3 = st.tabs(["๐๏ธ ุฅูุดุงุกุงุช ููุจุงูู", "๐จ ุชุดุทูุจุงุช ููุฌุงุฑุฉ", "๐ฟ ุดุจูุงุช ูููุงุณูุฑ"])
        
        with t1:
            c = st.columns(2)
            c[0].metric("ุฃุณููุช (ุทู)", f"{results['ุฃุณููุช (ุทู)']:,.2f}")
            c[0].metric("ุญุฏูุฏ ุชุณููุญ (ุทู)", f"{results['ุญุฏูุฏ (ุทู)']:,.2f}")
            c[1].metric("ุฑูู ูุณู (ู3)", f"{results['ุฑูู (ู3)']+results['ุณู/ุฒูุท (ู3)']:,.2f}")
            c[1].metric("ุทูุจ (ุฃูู ุทูุจุฉ)", f"{results['ุทูุจ (ุฃูู)']:,.2f}")
        
        with t2:
            c = st.columns(2)
            c[0].metric("ุณูุฑุงููู/ุจูุฑุณููู (ู2)", f"{results['ุณูุฑุงููู (ู2)']:,.2f}")
            c[0].metric("ุฏูุงูุงุช (ุจุณุชูุฉ)", f"{results['ุฏูุงูุงุช (ุจุณุชูุฉ)']:,.2f}")
            c[1].metric("ุฃุจูุงุจ (ุนุฏุฏ)", f"{results['ุฃุจูุงุจ (ุนุฏุฏ)']:,.2f}")
            c[1].metric("ุดุจุงุจูู (ุนุฏุฏ)", f"{results['ุดุจุงุจูู (ุนุฏุฏ)']:,.2f}")
        
        with t3:
            st.metric("ุฅุฌูุงูู ุงูููุงุณูุฑ ูุงูุดุจูุงุช (ู.ุท)", f"{results['ููุงุณูุฑ ุดุจูุงุช (ู.ุท)']:,.2f}")
            st.success("ุชู ุงูุญุตุฑ ุจูุฌุงุญ ุจูุงุกู ุนูู ุงุฎุชูุงุฑู ููุฃุนูุฏุฉ.")
