import streamlit as st
import pandas as pd

# 1. ุฅุนุฏุงุฏุงุช ุงูุตูุญุฉ
st.set_page_config(page_title="MNSA - ุงูููุชุจ ุงูููู ุงูุฐูู", layout="wide")

st.title("๐๏ธ ุขูุฉ ุงูููุชุจ ุงูููู ูุดุฑูุฉ MNSA")
st.markdown("### ุชุญููู ุงูููุงูุณุงุช (ุฅูุดุงุฆู - ุชุดุทูุจุงุช - ุดุจูุงุช - ุญุฑูู)")

# 2. ูุญุฑู ุงูุชุญููู ุงูููุฏุณู (Engineering Logic Engine)
def analyze_boq(df):
    # ูุตูููุฉ ุงููุชุงุฆุฌ
    summary = {
        "ุฅุฌูุงูู ุงูุฃุณููุช (ุทู)": 0,
        "ุฅุฌูุงูู ุงูุฑูู (ู3)": 0,
        "ุฅุฌูุงูู ุงูุณู/ุงูุฒูุท (ู3)": 0,
        "ุญุฏูุฏ ุชุณููุญ (ุทู)": 0,
        "ุฏูุงูุงุช (ุจุณุชูุฉ)": 0,
        "ุณูุฑุงููู/ุจูุฑุณููู (ู2)": 0,
        "ูุคููุฉ ูุตู (ุดูุงุฑุฉ)": 0,
        "ููุงุณูุฑ ุญุฑูู (ู.ุท)": 0
    }
    
    for index, row in df.iterrows():
        # ุชูุธูู ุงููุต ููุจุญุซ
        item = str(row.get('ุงูุจูุงู', '')).lower()
        qty = float(row.get('ุงููููุฉ', 0))

        # --- ุฃ. ุฃุนูุงู ุงูุฎุฑุณุงูุงุช ูุงููุจุงูู ---
        if "ุฎุฑุณุงูุฉ ูุณูุญุฉ" in item:
            summary["ุฅุฌูุงูู ุงูุฃุณููุช (ุทู)"] += qty * 0.350
            summary["ุฅุฌูุงูู ุงูุฑูู (ู3)"] += qty * 0.4
            summary["ุฅุฌูุงูู ุงูุณู/ุงูุฒูุท (ู3)"] += qty * 0.8
            summary["ุญุฏูุฏ ุชุณููุญ (ุทู)"] += qty * 0.090 # ูุฑุถูุฉ 90ูุฌู/ู3
        elif "ุฎุฑุณุงูุฉ ุนุงุฏูุฉ" in item:
            summary["ุฅุฌูุงูู ุงูุฃุณููุช (ุทู)"] += qty * 0.250
            summary["ุฅุฌูุงูู ุงูุฑูู (ู3)"] += qty * 0.4
            summary["ุฅุฌูุงูู ุงูุณู/ุงูุฒูุท (ู3)"] += qty * 0.8
        
        # --- ุจ. ุฃุนูุงู ุงูุชุดุทูุจุงุช ---
        if "ุณูุฑุงููู" in item or "ุจูุฑุณููู" in item:
            summary["ุณูุฑุงููู/ุจูุฑุณููู (ู2)"] += qty
            summary["ูุคููุฉ ูุตู (ุดูุงุฑุฉ)"] += qty * 0.25 # ุดูุงุฑุฉ ููู 4 ูุชุฑ
            summary["ุฅุฌูุงูู ุงูุฑูู (ู3)"] += qty * 0.04 # ุฑูู ุฃุณูู ุงูุณูุฑุงููู
        
        if "ุฏูุงูุงุช" in item or "ุจูุงุณุชูู" in item:
            summary["ุฏูุงูุงุช (ุจุณุชูุฉ)"] += qty / 30 # ูุฑุถูุฉ ุจุณุชูุฉ ููู 30 ูุชุฑ (3 ุณูุงููู)
            
        if "ูุญุงุฑุฉ" in item or "ุจูุงุถ" in item:
            summary["ุฅุฌูุงูู ุงูุฃุณููุช (ุทู)"] += qty * 0.012
            summary["ุฅุฌูุงูู ุงูุฑูู (ู3)"] += qty * 0.03

        # --- ุฌ. ุฃุนูุงู ุงูุดุจูุงุช ูุงูุญุฑูู ---
        if "ููุงุณูุฑ" in item and "ุญุฑูู" in item:
            summary["ููุงุณูุฑ ุญุฑูู (ู.ุท)"] += qty
        if "ููุงุณูุฑ" in item and ("ุตุฑู" in item or "pvc" in item):
            # ูููู ุฅุถุงูุฉ ุญุตุฑ ุจุฃูุทุงุฑ ูุนููุฉ ููุง
            pass

    return summary

# 3. ูุงุฌูุฉ ุงููุณุชุฎุฏู
uploaded_file = st.file_uploader("ุงุฑูุน ููุงูุณุฉ ุงููุดุฑูุน (Excel)", type=['xlsx'])

if uploaded_file:
    df = pd.read_excel(uploaded_file)
    st.subheader("๐ ูุนุงููุฉ ุจููุฏ ุงูููุงูุณุฉ ุงููุฑููุนุฉ")
    st.dataframe(df, use_container_width=True)
    
    if st.button("๐ ุชุดุบูู ุขูุฉ ุงูุญุตุฑ ูุงูุชุญููู"):
        results = analyze_boq(df)
        
        st.markdown("---")
        st.header("๐ ูุชุงุฆุฌ ุญุตุฑ ุงูููุชุจ ุงูููู (ุชูุฏูุฑู)")
        
        # ุนุฑุถ ุงููุชุงุฆุฌ ูู ุดุจูุฉ ููุธูุฉ
        rows = [list(results.items())[i:i+4] for i in range(0, len(results), 4)]
        for row in rows:
            cols = st.columns(4)
            for i, (label, value) in enumerate(row):
                cols[i].metric(label, f"{value:,.2f}")
        
        # ูุณู ุฎุงุต ููููุงุญุธุงุช ุงูููุฏุณูุฉ
        with st.expander("โน๏ธ ููุงุญุธุงุช ูููุฉ ุญูู ุงูุญุตุฑ"):
            st.write("""
            - **ุงูุฎุฑุณุงูุงุช:** ุชู ุญุณุงุจ ุงูุฃุณููุช ุจูุชูุณุท 7 ุดูุงูุฑ ูููุณูุญุฉ ู5 ููุนุงุฏูุฉ.
            - **ุงูุชุดุทูุจุงุช:** ุงูุณูุฑุงููู ูุดูู ูุงูู ุชูุฏูุฑู 5%ุ ูุงูุฏูุงูุงุช ูุญุณูุจุฉ ุนูู ุฃุณุงุณ ูุฌููู ูุจุทุงูุฉ.
            - **ุงูุดุจูุงุช:** ูุชู ุญุตุฑ ุงูููุงุณูุฑ ุจุงูุฃุทูุงู ุงูุทูููุฉ ุงููุฐููุฑุฉ ูู ุงูููุงูุณุฉ.
            """)
